## Гайд для фронтенд‑разработчика

Этот документ описывает, как сейчас устроен фронт и API, чтобы упростить полную или частичную переработку клиентской части (SPA, React/Vue/Svelte и т.п.).

Серверная часть – Django + DRF, базовый URL API: `/api`.

---

## Аутентификация и работа с токенами

### Регистрация / логин

- `POST /api/registration/`
  - Тело: JSON с полями пользователя (логин, пароль и т.п. – см. сериализатор в `wallet_nalog/serializers.py`).
  - Ответ: данные пользователя + `access`/`refresh` токены.

- `POST /api/login/`
  - Тело: `{ "username": "...", "password": "..." }`
  - Ответ (успех, 200):
    ```json
    {
      "user": { ... },
      "access": "<JWT access>",
      "refresh": "<JWT refresh>"
    }
    ```

- `POST /api/refresh/`
  - Тело: `{ "refresh": "<текущий refresh>" }`
  - Ответ:
    ```json
    {
      "access": "<новый access>",
      "refresh": "<новый refresh>"
    }
    ```

### Как использовать на фронте

- Хранить `access` и `refresh` в `localStorage` (как сейчас) или в памяти.
- Все защищённые запросы к `/api/...` отправлять с заголовком:

```http
Authorization: Bearer <access>
```

- При получении 401/403 и сообщении о просроченном токене:
  1. Один раз попытаться обновить токен через `/api/refresh/`.
  2. Повторить оригинальный запрос с новым `access`.
  3. При ошибке обновления – разлогинить пользователя.

В текущем шаблоне `wallet_test.html` эта логика инкапсулирована в функции `fetchWithAuth(url, options)`.

---

## Работа с кошельком

### Подключение кошелька (TON Connect)

Фронт сейчас использует стандартную TON Connect UI‑библиотеку в шаблоне `wallet_test.html` и манифест `wallet_nalog/static/tonconnect-manifest.json`.

От фронта требуется:

- Инициализировать TON Connect, указав URL манифеста (он отдаётся Django по пути `/tonconnect-manifest.json`).
- После подключения кошелька:
  - прочитать адрес кошелька;
  - отправить его на бэкенд (эндпоинт `POST /api/Wallet/` / `PATCH /api/Wallet/` – см. `views.py`) для сохранения в `WalletSession`.

На стороне Django:

- Пользователь–владелец кошелька определяется по JWT.
- Адрес кошелька берётся из `request.user.wallet.wallet_address`.

### Получение информации о кошельке

- `GET /api/Wallet/`
  - Вернёт информацию о текущем подключенном кошельке для залогиненного пользователя.

- `PATCH /api/Wallet/`
  - Позволяет обновить поля сессии (например, `wallet_address`) – используется при подключении/переподключении кошелька.

---

## Баланс и транзакции

### Баланс

- `GET /api/wallet/balance/`
  - Требуется авторизация.
  - Ответ:
    ```json
    {
      "address": "0:....",
      "balance": 123.456789123,
      "is_active": true,
      "balance_ton": "123.456789123"
    }
    ```

### Транзакции

- `GET /api/wallet/transactions/`
  - Параметры:
    - `refresh=true` (опционально) – принудительно обновить историю из блокчейна.
  - Ответ (из БД):
    ```json
    {
      "transactions": [
        {
          "tx_hash": "...",
          "timestamp": "2025-12-09T00:37:16+00:00",
          "amount": 0.1,
          "amount_ton": "0.100000000",
          "from_address": "0:...",
          "to_address": "0:...",
          "status": "completed",
          "created_at": "2025-12-09T01:00:00+00:00"
        },
        ...
      ],
      "count": 50,
      "loaded_from_blockchain": 0,
      "saved_to_db": 0,
      "from_cache": true
    }
    ```

Поведение:

- Если в БД уже есть транзакции для кошелька, по умолчанию (без `refresh`) возвращаются **последние 50** и параллельно в фоне запускается обновление из блокчейна.
- При `refresh=true` фронт может инициировать явное обновление истории (подходит для кнопки «Обновить транзакции»).

### Направление транзакций

Для определения исходящих/входящих:

- Исходящая транзакция: `from_address == walletAddress`.
- Входящая: `to_address == walletAddress`.

При отрисовке фронту удобно:

- заводить поле `isOutgoing = tx.from_address === walletAddress`;
- отображать знак/цвет/иконку в зависимости от направления.

---

## Налог – API для фронта

Ниже интерфейс функций, которые использует фронт. Все эндпоинты требуют валидного JWT.

### Налог за месяц

- `GET /api/tax/month/?year=YYYY&month=MM`
  - Параметры:
    - `year` – 4‑значный год;
    - `month` – месяц от 1 до 12.
  - Ответ (пример):
    ```json
    {
      "year": 2025,
      "month": 11,
      "total_sent_ton": 1842.6595,
      "total_sent_usd": 2892.975415,
      "total_tax_ton": 18.426595,
      "total_tax_usd": 28.92975415,
      "transactions_count": 12,
      "transactions": [
        {
          "tx_hash": "...",
          "timestamp": "2025-11-01T10:00:00+00:00",
          "amount_ton": 100.0,
          "amount_usd": 150.0,
          "tax_rate": 0.01,
          "tax_amount_ton": 1.0,
          "tax_amount_usd": 1.5
        }
      ]
    }
    ```

### Налог по всем месяцам

- `GET /api/tax/all/?start_year=YYYY&start_month=MM`
  - Оба параметра опциональны; если их нет – берётся первый месяц, в котором есть исходящие транзакции.
  - Ответ:
    ```json
    {
      "monthly_taxes": [
        {
          "year": 2025,
          "month": 11,
          "total_sent_ton": 1842.6595,
          "total_sent_usd": 2892.975415,
          "total_tax_ton": 18.426595,
          "total_tax_usd": 28.92975415,
          "transactions_count": 12
        },
        {
          "year": 2025,
          "month": 12,
          "total_sent_ton": 4649.5344,
          "total_sent_usd": 7299.769008,
          "total_tax_ton": 46.495344,
          "total_tax_usd": 72.99769008,
          "transactions_count": 20
        }
      ],
      "count": 2
    }
    ```

Фронт может:

- строить список месяцев с налогом;
- по клику по месяцу:
  - либо просто отображать эти агрегированные данные;
  - либо дополнительно запрашивать `/api/tax/month/` для детальной разбивки по транзакциям.

### Итоговый налог

- `GET /api/tax/total/?start_year=YYYY&start_month=MM`
  - Ответ:
    ```json
    {
      "total_tax_ton": 65.0,
      "total_tax_usd": 100.0,
      "total_sent_ton": 6000.0,
      "total_sent_usd": 9000.0,
      "total_transactions": 32,
      "ton_price_usd": 1.5,
      "monthly_taxes": [ ... как в /api/tax/all/ ... ],
      "period": {
        "start": "2025-11",
        "end": "2025-12"
      }
    }
    ```

---

## Текущая структура фронта (шаблон)

Файл: `wallet_nalog/templates/wallet_nalog/wallet_test.html`

Основные блоки:

- Форма логина / регистрации.
- Кнопка подключения TON‑кошелька через TON Connect.
- Блок «Баланс» – показывает адрес и текущий баланс.
- Блок «Транзакции»:
  - кнопка «Загрузить транзакции» (обычный запрос);
  - кнопка «Обновить транзакции» (`refresh=true`);
  - таблица с транзакциями, где подсветка направления основана на сравнении с `walletAddress`.
- Блок «Налог»:
  - форма для расчёта за конкретный месяц (год + месяц);
  - форма для расчёта помесячно с даты (год/месяц начала);
  - кнопки:
    - «Посчитать за месяц» → `/api/tax/month/`;
    - «Помесячно» → `/api/tax/all/`;
    - «Итоговый налог» → `/api/tax/total/`;
  - список месяцев с налогом и кликабельные месяцы для показа деталей (использует кэш `monthly_taxes` на фронте).

Вся логика сейчас реализована на «чистом» JavaScript, без сборщика. При переписывании фронта можно:

- использовать эти API как есть;
- вынести:
  - модуль `auth` (логин, refresh);
  - модуль `wallet` (баланс, транзакции);
  - модуль `tax` (налоги за месяц/период/итог);
  - модуль `tonconnect` для подключения кошелька.

---

## Рекомендации по переписыванию фронта

- Сохранить все текущие REST‑эндпоинты и их контракты, чтобы не менять backend.
- Сделать общий HTTP‑клиент:
  - базовый URL = `window.location.origin + "/api"`;
  - автоматическая подстановка `Authorization`;
  - перехват 401/403 и авто‑refresh токена.
- Для работы с налогом:
  - использовать `/api/tax/all/` для построения списка месяцев;
  - по клику по месяцу:
    - либо использовать уже агрегированные данные из `monthly_taxes`;
    - либо при необходимости дополнительно вызывать `/api/tax/month/` для детальных данных по транзакциям.
- Учесть, что внешний API TON может отдавать не всю историю (ограничения по количеству транзакций и rate‑limit), поэтому:
  - фронт не должен обещать «историю за всю жизнь»;
  - лучше явно указывать пользователю, за какой период реально посчитан налог (поля `period.start` / `period.end` в ответе `/api/tax/total/`).


